{% extends "base.html" %}

{% block content %}
<div class="space-y-6">

  <!-- BaÅŸlÄ±k ve AÃ§Ä±klama -->
  <h2 class="text-3xl font-bold text-primary">ğŸ¬ {{ video.title }}</h2>
  <p class="text-gray-400">{{ video.description }}</p>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">

    <!-- Durum Kutusu (BaÄŸÄ±msÄ±z, her zaman gÃ¶rÃ¼nÃ¼r) -->
    <div class="bg-card p-4 rounded-lg shadow border border-border text-center">
      <h3 class="text-lg font-semibold text-cyan-300 mb-2">ğŸ“Š Video Durumu</h3>
      <span
        class="inline-block px-4 py-2 rounded-full font-bold text-sm
        {% if video.status == 'COMPLETED' %}bg-green-600 text-green-100
        {% elif video.status == 'ERROR' %}bg-red-600 text-red-100
        {% else %}bg-yellow-500 text-yellow-100{% endif %}">
        {{ video.get_status_display }}
      </span>
      {% if video.error_message %}
      <p class="mt-2 text-red-400 text-xs italic">Hata: {{ video.error_message }}</p>
      {% endif %}
    </div>

    {% if video.final_video %}
    <!-- Final Video + GÃ¶rÃ¼ntÃ¼leme AlanÄ± -->
    <div class="bg-card p-4 rounded-lg shadow border border-border col-span-2">
      <h3 class="text-lg font-semibold text-cyan-300 mb-2">ğŸ¥ Final Video</h3>
      <video class="w-full rounded" controls>
        <source src="{{ video.final_video.url }}" type="video/mp4" />
        TarayÄ±cÄ±nÄ±z video formatÄ±nÄ± desteklemiyor.
      </video>
      <a href="{{ video.final_video.url }}" target="_blank"
        class="block mt-3 text-cyan-400 hover:underline text-sm">ğŸï¸ Videoyu Ä°zle / Ä°ndir</a>
    </div>
    {% endif %}

  </div>

  <!-- AI Ä°Ã§erikler, Ses, AltyazÄ±, GÃ¶rseller -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">

    <!-- AI Content -->
    <div class="bg-card p-4 rounded-lg shadow border border-border space-y-3 col-span-1">
      <h3 class="text-lg font-semibold text-cyan-300">ğŸ¤– AI Ä°Ã§erik</h3>
      {% if video.ai_content %}
        <p><strong>BaÅŸlÄ±k:</strong> <span class="ai-content-title">{{ video.ai_content.title }}</span></p>
        <p><strong>AÃ§Ä±klama:</strong> <span class="ai-content-description">{{ video.ai_content.description }}</span></p>
        <p><strong>Hashtagler:</strong> <span class="ai-content-hashtags">
        {% for tag in video.ai_content.hashtags %}
            <span class="text-sm text-cyan-400">#{{ tag }}</span>{% if not forloop.last %}, {% endif %}
        {% endfor %}
        </span></p>
        <details class="mt-2 ai-content-script">
        <summary class="cursor-pointer text-cyan-300 font-semibold">Senaryo / Metin</summary>
        <pre class="whitespace-pre-wrap bg-gray-900 p-2 rounded text-sm">{{ video.ai_content.script }}</pre>
        </details>
      {% else %}
        <p class="text-gray-400 italic">HenÃ¼z AI iÃ§erik oluÅŸturulmadÄ±.</p>
      {% endif %}
    </div>

    <!-- Ses ve AltyazÄ± -->
    <div class="bg-card p-4 rounded-lg shadow border border-border space-y-4 col-span-1">
      <h3 class="text-lg font-semibold text-cyan-300">ğŸ”Š Ses & AltyazÄ±</h3>
      {% if video.voice_file %}
        <audio controls class="w-full">
          <source src="{{ video.voice_file.url }}" type="audio/mpeg">
          TarayÄ±cÄ±nÄ±z ses formatÄ±nÄ± desteklemiyor.
        </audio>
        <a href="{{ video.voice_file.url }}" target="_blank" class="text-cyan-400 underline text-sm block mt-1">ğŸ§ Sesi Ä°ndir</a>
      {% else %}
        <p class="text-gray-400 italic">Ses dosyasÄ± yok.</p>
      {% endif %}
      
      {% if video.subtitle_file %}
        <a href="{{ video.subtitle_file.url }}" target="_blank" class="text-cyan-400 underline text-sm block mt-2">ğŸ“ AltyazÄ± DosyasÄ±nÄ± Ä°ndir</a>
      {% else %}
        <p class="text-gray-400 italic mt-2">AltyazÄ± dosyasÄ± yok.</p>
      {% endif %}
    </div>

    <!-- GÃ¶rseller -->
    <div class="bg-card p-4 rounded-lg shadow border border-border space-y-3 col-span-1">
      <h3 class="text-lg font-semibold text-cyan-300">ğŸ–¼ï¸ GÃ¶rseller</h3>
      {% if video.images.count > 0 %}
        <div class="grid grid-cols-2 gap-2">
          {% for img in video.images.all %}
            <img src="{{ img.image.url }}" alt="Video GÃ¶rseli" class="rounded w-full object-cover">
          {% endfor %}
        </div>
      {% else %}
        <p class="text-gray-400 italic">GÃ¶rsel eklenmemiÅŸ.</p>
      {% endif %}
    </div>

    <!-- Thumbnail -->
    <div class="bg-card p-4 rounded-lg shadow border border-border space-y-3 col-span-1">
        <h3 class="text-lg font-semibold text-cyan-300">ğŸ“Œ Thumbnail</h3>
        {% if video.thumbnail %}
            <img src="{{ video.thumbnail.url }}" alt="Video Thumbnail" class="rounded w-full object-cover thumbnail-output">
            <a href="{{ video.thumbnail.url }}" target="_blank" class="block text-cyan-400 underline text-sm mt-2">ğŸ” Tam GÃ¶r</a>
        {% else %}
            <p class="text-gray-400 italic thumbnail-output">Thumbnail Ã¼retilmemiÅŸ.</p>
        {% endif %}
    </div>

  </div>

    <!-- Ãœretim AdÄ±mlarÄ± (Her zaman gÃ¶rÃ¼nÃ¼r) -->
    <div class="bg-card p-6 rounded-lg shadow border border-border mt-6 space-y-4">
        <h3 class="text-xl font-semibold text-cyan-300">ğŸ“‹ Ãœretim AdÄ±mlarÄ±</h3>

        <div class="space-y-3 max-w-sm">
            <button data-step="text" data-video-id="{{ video.id }}" class="btn-step"
            {% comment %}Her zaman aktif{% endcomment %}>1ï¸âƒ£ Metin Ãœret</button>

            <button data-step="voice" data-video-id="{{ video.id }}" class="btn-step
            {% if not video.ai_content %} opacity-50 cursor-not-allowed" disabled title="Ã–nce metin Ã¼retmelisiniz"
            {% else %}"{% endif %}>2ï¸âƒ£ Ses Ãœret</button>

            <button data-step="subtitle" data-video-id="{{ video.id }}" class="btn-step
            {% if not video.voice_file %} opacity-50 cursor-not-allowed" disabled title="Ã–nce ses Ã¼retmelisiniz"
            {% else %}"{% endif %}>3ï¸âƒ£ AltyazÄ± Ãœret</button>

            <button data-step="content_images" data-video-id="{{ video.id }}" class="btn-step
            {% if not video.subtitle_file %} opacity-50 cursor-not-allowed" disabled title="Ã–nce altyazÄ± Ã¼retmelisiniz"
            {% else %}"{% endif %}>4ï¸âƒ£ Ä°Ã§erik GÃ¶rselleri Ãœret</button>

            <button data-step="thumbnail_image" data-video-id="{{ video.id }}" class="btn-step
            {% if not video.images.exists %} opacity-50 cursor-not-allowed" disabled title="Ã–nce iÃ§erik gÃ¶rselleri Ã¼retilmeli"
            {% else %}"{% endif %}>5ï¸âƒ£ Thumbnail Ãœret</button>

            <button data-step="edit" data-video-id="{{ video.id }}" class="btn-step
            {% if not video.images.exists %} opacity-50 cursor-not-allowed" disabled title="Ã–nce gÃ¶rseller Ã¼retilmeli"
            {% else %}"{% endif %}>6ï¸âƒ£ Montajla</button>
        </div>

        <div id="step-result" class="text-sm text-gray-300 pt-2 italic"></div>
    </div>

</div>

<script>
    function runStep(videoId, step) {
        const $status = $('#status');
        const $result = $('#step-result');
        const $button = $(`button.btn-step[data-step="${step}"][data-video-id="${videoId}"]`);

        $status.text('Ä°ÅŸleniyor...');
        $result.text('');
        $button.prop('disabled', true).addClass('opacity-50 cursor-not-allowed');

        $.ajax({
            url: `/videos/${videoId}/generate/${step}/`,
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            success: function(res) {
            if (res.success) {
                $status.text(res.new_status || 'TamamlandÄ±');

                if (step === 'text' && res.ai_content) {
                const ai = res.ai_content;
                $('.ai-content-title').text(ai.title || '');
                $('.ai-content-description').text(ai.description || '');

                if (ai.hashtags && ai.hashtags.length) {
                    let hashtagsHtml = '';
                    ai.hashtags.forEach((tag, idx) => {
                    hashtagsHtml += `<span class="text-sm text-cyan-400">#${tag}</span>`;
                    if (idx !== ai.hashtags.length - 1) hashtagsHtml += ', ';
                    });
                    $('.ai-content-hashtags').html(hashtagsHtml);
                } else {
                    $('.ai-content-hashtags').html('');
                }

                $('.ai-content-script pre').text(ai.script || '');
                $result.html('<p class="text-green-400 font-semibold">Metin baÅŸarÄ±yla Ã¼retildi.</p>');
                }

                if (step === 'voice' && res.voice_file_url) {
                const audioHtml = `
                    <audio controls class="w-full">
                    <source src="${res.voice_file_url}" type="audio/mpeg">
                    TarayÄ±cÄ±nÄ±z ses formatÄ±nÄ± desteklemiyor.
                    </audio>
                    <a href="${res.voice_file_url}" target="_blank" class="text-cyan-400 underline text-sm block mt-1">ğŸ§ Sesi Ä°ndir</a>
                `;
                $('.voice-output').html(audioHtml);
                $result.html('<p class="text-green-400 font-semibold">Ses baÅŸarÄ±yla Ã¼retildi.</p>');
                }

                if (step === 'subtitle' && res.subtitle_file_url) {
                const subtitleHtml = `
                    <a href="${res.subtitle_file_url}" target="_blank" class="text-cyan-400 underline text-sm block mt-2">ğŸ“ AltyazÄ± DosyasÄ±nÄ± Ä°ndir</a>
                `;
                $('.subtitle-output').html(subtitleHtml);
                $result.html('<p class="text-green-400 font-semibold">AltyazÄ± baÅŸarÄ±yla Ã¼retildi.</p>');
                }

                if (step === 'images' && res.images && res.images.length > 0) {
                let imagesHtml = '<div class="grid grid-cols-2 gap-2">';
                res.images.forEach(imgUrl => {
                    imagesHtml += `<img src="${imgUrl}" alt="GÃ¶rsel" class="rounded w-full object-cover">`;
                });
                imagesHtml += '</div>';
                $('.image-output').html(imagesHtml);
                $result.html('<p class="text-green-400 font-semibold">GÃ¶rseller baÅŸarÄ±yla Ã¼retildi.</p>');
                }

                if (step === 'thumbnail_image' && res.thumbnail_url) {
                const thumbHtml = `
                    <img src="${res.thumbnail_url}" alt="Video Thumbnail" class="w-full rounded shadow mt-4"/>
                `;
                $('.thumbnail-output').html(thumbHtml);
                $result.html('<p class="text-green-400 font-semibold">Thumbnail baÅŸarÄ±yla Ã¼retildi.</p>');
                }

                if (step === 'edit' && res.final_video_url) {
                const videoHtml = `
                    <video class="w-full rounded" controls>
                    <source src="${res.final_video_url}" type="video/mp4" />
                    TarayÄ±cÄ±nÄ±z video formatÄ±nÄ± desteklemiyor.
                    </video>
                    <a href="${res.final_video_url}" target="_blank" class="block mt-3 text-cyan-400 hover:underline text-sm">ğŸï¸ Videoyu Ä°zle / Ä°ndir</a>
                `;
                $('.final-video-output').html(videoHtml);
                $result.html('<p class="text-green-400 font-semibold">Montaj baÅŸarÄ±yla tamamlandÄ±.</p>');
                }

                // SonuÃ§ linki varsa gÃ¶ster
                if (res.video_url) {
                $result.append(`<br><a href="${res.video_url}" target="_blank" class="text-cyan-400 underline">Videoyu Ä°zle</a>`);
                }

                // Sonraki adÄ±mÄ± aktif et
                if (step === 'text') enableNextStep('voice', videoId);
                else if (step === 'voice') enableNextStep('subtitle', videoId);
                else if (step === 'subtitle') enableNextStep('images', videoId);
                else if (step === 'images') enableNextStep('edit', videoId);

            } else {
                $status.text('Hata');
                $result.text('Hata: ' + (res.error || 'Bilinmeyen'));
            }
            },
            error: function() {
            $status.text('Hata');
            $result.text('Sunucuya eriÅŸilemedi.');
            },
            complete: function() {
            $button.prop('disabled', false).removeClass('opacity-50 cursor-not-allowed');
            }
        });
        }

    function enableNextStep(step, videoId) {
        $(`button.btn-step[data-step="${step}"][data-video-id="${videoId}"]`)
            .prop('disabled', false)
            .removeClass('opacity-50 cursor-not-allowed')
            .attr('title', '');
    }

    $(document).on('click', 'button.btn-step:not(:disabled)', function() {
        const step = $(this).data('step');
        const videoId = $(this).data('video-id');
        runStep(videoId, step);
    });

    $(document).ready(function() {
        function setStepButtonsStatus(video) {
            // video deÄŸiÅŸkeni Django'dan JSON olarak geÃ§ilebilir
            const steps = [
                { step: 'text', key: null },
                { step: 'voice', key: video.ai_content },
                { step: 'subtitle', key: video.voice_file },
                { step: 'images', key: video.subtitle_file },
                { step: 'edit', key: video.images && video.images.length > 0 },
            ];

            steps.forEach(({ step, key }, idx) => {
                const $btn = $(`.btn-step[data-step="${step}"]`);
                if (idx === 0 || key) {
                $btn.prop('disabled', false).removeClass('opacity-50 cursor-not-allowed').attr('title', '');
                } else {
                $btn.prop('disabled', true).addClass('opacity-50 cursor-not-allowed').attr('title', 'Ã–nceki adÄ±mÄ± tamamlayÄ±n');
                }
            });
            }

        // Sayfa yÃ¼klendiÄŸinde sadece 1. step aktif olsun
        setStepButtonsStatus(null);
    });
</script>

<style>
  .btn-step {
    display: block;
    width: 100%;
    background-color: #0ea5e9;
    color: black;
    padding: 0.75rem;
    font-weight: 600;
    border-radius: 0.5rem;
    text-align: center;
    transition: all 0.2s ease;
  }
  .btn-step:hover {
    background-color: #38bdf8;
  }
  .bg-card {
    background-color: #1f2937; /* Tailwind slate-800 */
  }
  .text-primary {
    color: #0ea5e9; /* Tailwind sky-500 */
  }
  .text-cyan-300 {
    color: #67e8f9;
  }
  .border-border {
    border-color: #334155; /* Tailwind slate-700 */
  }
</style>

{% endblock %}
